<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>게임 플레이</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to bottom, #0a0a0a, #1a1a2e);
            color: #00eaff;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            cursor: url('cursor.png'), auto;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            color: #ffcc00;
            text-shadow: 0 0 10px #ffcc00;
            text-align: center;
            margin-bottom: 20px;
        }

        #startBtn {
            display: block;
            margin: 0 auto 20px auto;
            background: #1a1a2e;
            border: 2px solid #ffcc00;
            color: #ffcc00;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 15px #ffcc00;
            transition: all 0.2s ease;
        }

        #startBtn:hover {
            background: #ffcc00;
            color: black;
            box-shadow: 0 0 25px #ffcc00;
        }

        #score {
            font-size: 20px;
            font-weight: bold;
            color: #00ff00;
        }

        #chat-box {
            height: 200px;
            overflow-y: auto;
            border: 2px solid #00eaff;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            color: #00eaff;
        }

        #input-box {
            display: flex;
            gap: 10px;
        }

        #answer {
            flex: 1;
            padding: 5px 10px;
            border: 2px solid #00eaff;
            border-radius: 5px;
            background: black;
            color: #00eaff;
        }

        #input-box button {
            background: #1a1a2e;
            border: 2px solid #ffcc00;
            color: #ffcc00;
            padding: 5px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 0 10px #ffcc00;
            transition: all 0.2s ease;
        }

        #input-box button:hover {
            background: #ffcc00;
            color: black;
            box-shadow: 0 0 20px #ffcc00;
        }

        iframe {
            display: none; /* 유튜브 영상은 숨김 */
        }
    </style>
</head>
<body>
<p th:text="${nickname} + '님의 방'"></p>
<button id="startBtn">게임 시작</button>
<br>



<hr />

<div>
    <strong>맞춘 개수:</strong> <span id="score">0</span>
</div>

<hr />

<!-- 유튜브 영상 출력 -->
<iframe id="music-frame"
        style="position: absolute; top: -9999px; left: -9999px;"
        frameborder="0" allow="autoplay" allowfullscreen></iframe>

<hr />

<!-- 채팅창 -->
<div id="chat-box" style="height:200px; overflow-y:auto; border:1px solid #ccc;"></div>

<!-- 정답 입력창 -->
<div id="input-box">
    <input type="text" id="answer" placeholder="정답을 입력하세요" />
    <button onclick="submitAnswer()">입력</button>
</div>

<script th:inline="javascript">
    const roomId = [[${roomId}]];
    const userId = [[${userId}]];
    const nickname = [[${nickname}]];
    let score = 0;
    let started = false;

    document.getElementById('startBtn').addEventListener('click', () => {
        if (started) return;
        started = true;

        fetch(`/api/music/${roomId}/${userId}/music`)
            .then(res => {
                if (!res.ok) throw new Error('음악 없음');
                return res.json();
            })
            .then(music => {
                const iframe = document.getElementById('music-frame');
                iframe.src = `https://www.youtube.com/embed/${music.youtube_id}?autoplay=1&mute=0`;
                iframe.style.opacity = 1;
                document.getElementById('startBtn').style.display = 'none';
            })
            .catch(() => {
                fetch(`/api/music/${roomId}/${userId}/result`)
                    .then(res => res.json())
                    .then(result => {
                        alert(`게임 종료\n1등: ${result.userDTO.nickname} (${score})`);
                        window.location.href = "/music"; // 종료 후 메인으로 이동
                    });
            });
    });

    function submitAnswer() {
        const input = document.getElementById('answer');
        const value = input.value.trim();
        if (!value || !started) return;

        fetch(`/api/music/${roomId}/${userId}/check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: value })
        })
        .then(res => res.json())
        .then(correct => {
            const chatBox = document.getElementById('chat-box');
            const msg = document.createElement('div');

            if (correct) {
                score++;
                document.getElementById('score').textContent = score;
                msg.textContent = nickname + ' : ' + value;
                msg.style.color = 'green';

                // 다음 노래
                fetch(`/api/music/${roomId}/${userId}/music`)
                    .then(res => {
                        if (!res.ok) throw new Error('노래 없음');
                        return res.json();
                    })
                    .then(next => {
                        const iframe = document.getElementById('music-frame');
                        iframe.src = `https://www.youtube.com/embed/${next.youtube_id}?autoplay=1&mute=0`;
                    })
                    .catch(() => {
                        fetch(`/api/music/${roomId}/${userId}/result`)
                            .then(res => res.json())
                            .then(result => {
                                alert(`게임 종료\n1등: ${result.userDTO.nickname} (${score})`);
                                window.location.href = "/music/main";
                            });
                    });
            } else {
                msg.textContent = nickname + ' : ' + value;
                msg.style.color = '#00eaff';
            }

            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;

            input.value = '';
            input.focus();
        });
    }

    document.getElementById('answer').addEventListener('keydown', e => {
        if (e.key === 'Enter') submitAnswer();
    });
</script>



</body>
</html>
